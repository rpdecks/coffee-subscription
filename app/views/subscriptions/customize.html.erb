<div class="max-w-4xl mx-auto">
  <%= link_to "â† Back to Plans", subscription_plans_path, class: "text-blue-600 hover:text-blue-800 mb-8 inline-block" %>

  <div class="text-center mb-12">
    <h1 class="text-4xl font-bold text-gray-900 mb-4">Customize Your Subscription</h1>
    <p class="text-xl text-gray-600">Tailor your <%= @plan.name %> to your preferences</p>
  </div>

  <%= form_with url: subscription_checkout_path, method: :post, local: true, data: { turbo: false }, class: "space-y-12" do |f| %>
    <%= hidden_field_tag :plan_id, @plan.id %>

    <!-- Section 1: Choose Coffee -->
    <div class="bg-white p-8 rounded-lg shadow-sm border border-gray-200">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">1. Choose Your Coffee</h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <% @coffee_products.each do |coffee| %>
          <label class="cursor-pointer">
            <input type="radio" name="coffee_id" value="<%= coffee.id %>" class="peer sr-only" required />
            <div class="border-2 border-gray-200 peer-checked:border-blue-600 peer-checked:bg-blue-50 rounded-lg p-4 hover:border-gray-300 transition-colors">
              <div class="flex justify-between items-start mb-2">
                <h3 class="font-bold text-gray-900"><%= coffee.name %></h3>
                <span class="text-sm text-gray-600">$<%= sprintf('%.2f', coffee.price) %></span>
              </div>
              <p class="text-sm text-gray-600"><%= truncate(coffee.description, length: 100) %></p>
            </div>
          </label>
        <% end %>
      </div>
    </div>

    <!-- Section 2: Bag Size -->
    <div class="bg-white p-8 rounded-lg shadow-sm border border-gray-200">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">2. Choose Your Bag Size</h2>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <label class="cursor-pointer">
          <input type="radio" name="bag_size" value="12oz" class="peer sr-only" checked required />
          <div class="border-2 border-gray-200 peer-checked:border-blue-600 peer-checked:bg-blue-50 rounded-lg p-6 text-center hover:border-gray-300 transition-colors">
            <div class="text-3xl font-bold text-gray-900 mb-2">12 oz</div>
            <div class="text-sm text-gray-600">Perfect for 1 person</div>
            <div class="text-sm text-gray-500 mt-2">~20-25 cups</div>
          </div>
        </label>

        <label class="cursor-pointer">
          <input type="radio" name="bag_size" value="2lb" class="peer sr-only" required />
          <div class="border-2 border-gray-200 peer-checked:border-blue-600 peer-checked:bg-blue-50 rounded-lg p-6 text-center hover:border-gray-300 transition-colors">
            <div class="text-3xl font-bold text-gray-900 mb-2">2 lb</div>
            <div class="text-sm text-gray-600">Great for couples</div>
            <div class="text-sm text-gray-500 mt-2">~60-70 cups</div>
          </div>
        </label>

        <label class="cursor-pointer">
          <input type="radio" name="bag_size" value="5lb" class="peer sr-only" required />
          <div class="border-2 border-gray-200 peer-checked:border-blue-600 peer-checked:bg-blue-50 rounded-lg p-6 text-center hover:border-gray-300 transition-colors">
            <div class="text-3xl font-bold text-gray-900 mb-2">5 lb</div>
            <div class="text-sm text-gray-600">Ideal for families</div>
            <div class="text-sm text-gray-500 mt-2">~150+ cups</div>
          </div>
        </label>
      </div>
    </div>

    <!-- Section 3: Delivery Frequency -->
    <div class="bg-white p-8 rounded-lg shadow-sm border border-gray-200">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">3. Choose Delivery Frequency</h2>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <label class="cursor-pointer">
          <input type="radio" name="frequency" value="weekly" class="peer sr-only" <%= 'checked' if @plan.weekly? %> required />
          <div class="border-2 border-gray-200 peer-checked:border-blue-600 peer-checked:bg-blue-50 rounded-lg p-6 text-center hover:border-gray-300 transition-colors">
            <div class="text-2xl font-bold text-gray-900 mb-2">Weekly</div>
            <div class="text-sm text-gray-600">Every 7 days</div>
          </div>
        </label>

        <label class="cursor-pointer">
          <input type="radio" name="frequency" value="biweekly" class="peer sr-only" <%= 'checked' if @plan.biweekly? %> required />
          <div class="border-2 border-gray-200 peer-checked:border-blue-600 peer-checked:bg-blue-50 rounded-lg p-6 text-center hover:border-gray-300 transition-colors">
            <div class="text-2xl font-bold text-gray-900 mb-2">Bi-Weekly</div>
            <div class="text-sm text-gray-600">Every 14 days</div>
          </div>
        </label>

        <label class="cursor-pointer">
          <input type="radio" name="frequency" value="monthly" class="peer sr-only" <%= 'checked' if @plan.monthly? %> required />
          <div class="border-2 border-gray-200 peer-checked:border-blue-600 peer-checked:bg-blue-50 rounded-lg p-6 text-center hover:border-gray-300 transition-colors">
            <div class="text-2xl font-bold text-gray-900 mb-2">Monthly</div>
            <div class="text-sm text-gray-600">Every 30 days</div>
          </div>
        </label>
      </div>
    </div>

    <!-- Section 4: Shipping Address -->
    <div class="bg-white p-8 rounded-lg shadow-sm border border-gray-200">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">4. Shipping Address</h2>

      <% if current_user&.addresses&.shipping&.any? %>
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-3">Select an existing address or add a new one:</label>
          <div class="space-y-3">
            <% current_user.addresses.shipping.each do |address| %>
              <label class="cursor-pointer block">
                <input type="radio" name="address_id" value="<%= address.id %>" class="peer sr-only" <%= 'checked' if address.is_default %> />
                <div class="border-2 border-gray-200 peer-checked:border-blue-600 peer-checked:bg-blue-50 rounded-lg p-4 hover:border-gray-300 transition-colors">
                  <div class="font-semibold text-gray-900"><%= address.street_address %></div>
                  <% if address.street_address_2.present? %>
                    <div class="text-gray-700"><%= address.street_address_2 %></div>
                  <% end %>
                  <div class="text-gray-700"><%= address.city %>, <%= address.state %> <%= address.zip_code %></div>
                  <div class="text-gray-700"><%= address.country %></div>
                </div>
              </label>
            <% end %>
          </div>
        </div>

        <div class="border-t border-gray-200 pt-6">
          <label class="cursor-pointer block">
            <input type="radio" name="address_id" value="new" class="peer sr-only" />
            <div class="border-2 border-gray-200 peer-checked:border-blue-600 peer-checked:bg-blue-50 rounded-lg p-4 hover:border-gray-300 transition-colors text-center">
              <span class="font-semibold text-gray-900">+ Add New Address</span>
            </div>
          </label>
        </div>
      <% end %>

      <div id="new-address-fields" class="<%= 'hidden' if current_user&.addresses&.shipping&.any? %> space-y-4 <%= 'mt-6' if current_user&.addresses&.shipping&.any? %>">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Street Address *</label>
          <%= text_field_tag 'address[street_address]', nil, class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500", required: !current_user&.addresses&.shipping&.any? %>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Apartment, suite, etc. (optional)</label>
          <%= text_field_tag 'address[street_address_2]', nil, class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" %>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">City *</label>
            <%= text_field_tag 'address[city]', nil, class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500", required: !current_user&.addresses&.shipping&.any? %>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">State *</label>
            <%= text_field_tag 'address[state]', nil, class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500", placeholder: "e.g., CA", required: !current_user&.addresses&.shipping&.any? %>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Zip Code *</label>
            <%= text_field_tag 'address[zip_code]', nil, class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500", required: !current_user&.addresses&.shipping&.any? %>
          </div>
          <%= hidden_field_tag 'address[country]', 'United States' %>
        </div>
      </div>
    </div>

    <!-- Section 5: Grind Type -->
    <div class="bg-white p-8 rounded-lg shadow-sm border border-gray-200">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">5. Choose Grind Type</h2>

      <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
        <label class="cursor-pointer">
          <input type="radio" name="grind_type" value="whole_bean" class="peer sr-only" checked required />
          <div class="border-2 border-gray-200 peer-checked:border-blue-600 peer-checked:bg-blue-50 rounded-lg p-4 text-center hover:border-gray-300 transition-colors">
            <div class="font-bold text-gray-900 mb-1">Whole Bean</div>
            <div class="text-xs text-gray-600">Maximum freshness</div>
          </div>
        </label>

        <label class="cursor-pointer">
          <input type="radio" name="grind_type" value="coarse" class="peer sr-only" required />
          <div class="border-2 border-gray-200 peer-checked:border-blue-600 peer-checked:bg-blue-50 rounded-lg p-4 text-center hover:border-gray-300 transition-colors">
            <div class="font-bold text-gray-900 mb-1">Coarse</div>
            <div class="text-xs text-gray-600">French press</div>
          </div>
        </label>

        <label class="cursor-pointer">
          <input type="radio" name="grind_type" value="medium_grind" class="peer sr-only" required />
          <div class="border-2 border-gray-200 peer-checked:border-blue-600 peer-checked:bg-blue-50 rounded-lg p-4 text-center hover:border-gray-300 transition-colors">
            <div class="font-bold text-gray-900 mb-1">Medium</div>
            <div class="text-xs text-gray-600">Drip coffee</div>
          </div>
        </label>

        <label class="cursor-pointer">
          <input type="radio" name="grind_type" value="fine" class="peer sr-only" required />
          <div class="border-2 border-gray-200 peer-checked:border-blue-600 peer-checked:bg-blue-50 rounded-lg p-4 text-center hover:border-gray-300 transition-colors">
            <div class="font-bold text-gray-900 mb-1">Fine</div>
            <div class="text-xs text-gray-600">Pour over</div>
          </div>
        </label>

        <label class="cursor-pointer">
          <input type="radio" name="grind_type" value="espresso" class="peer sr-only" required />
          <div class="border-2 border-gray-200 peer-checked:border-blue-600 peer-checked:bg-blue-50 rounded-lg p-4 text-center hover:border-gray-300 transition-colors">
            <div class="font-bold text-gray-900 mb-1">Espresso</div>
            <div class="text-xs text-gray-600">Espresso machine</div>
          </div>
        </label>
      </div>
    </div>

    <!-- Summary & Submit -->
    <div class="bg-blue-50 p-8 rounded-lg border-2 border-blue-200">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Your Subscription Summary</h2>
      <div class="space-y-2 text-gray-700 mb-6">
        <p><strong>Plan:</strong> <%= @plan.name %></p>
        <p><strong>Base Price:</strong> $<%= sprintf('%.2f', @plan.price) %> per delivery</p>
        <p class="text-sm text-gray-600">Final price will be calculated based on your selections above.</p>
      </div>

      <div class="mt-6 flex items-start gap-3">
        <%= check_box_tag :newsletter_opt_in, "1", false,
                          id: "newsletter_opt_in",
                          class: "mt-1 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-600" %>
        <div>
          <%= label_tag :newsletter_opt_in, "Subscribe to the newsletter", class: "text-sm font-medium text-gray-700" %>
          <p class="text-xs text-gray-600">Optional. You can sign up again anytime.</p>
        </div>
      </div>

      <%= f.submit "Continue to Checkout", class: "w-full bg-blue-600 text-white px-8 py-4 rounded-lg text-xl font-semibold hover:bg-blue-700 transition-colors cursor-pointer" %>

      <p class="text-center text-sm text-gray-600 mt-4">
        You'll be able to review everything before finalizing your subscription.
      </p>
    </div>
  <% end %>
</div>

<script>
  // Show/hide new address fields based on selection
  document.addEventListener('DOMContentLoaded', function() {
    const addressRadios = document.querySelectorAll('input[name="address_id"]');
    const newAddressFields = document.getElementById('new-address-fields');
    const newAddressInputs = newAddressFields.querySelectorAll('input[required]');

    addressRadios.forEach(radio => {
      radio.addEventListener('change', function() {
        if (this.value === 'new') {
          newAddressFields.classList.remove('hidden');
          newAddressInputs.forEach(input => input.required = true);
        } else {
          newAddressFields.classList.add('hidden');
          newAddressInputs.forEach(input => input.required = false);
        }
      });
    });
  });
</script>
