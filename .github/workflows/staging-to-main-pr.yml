name: Staging to Main PR

on:
  push:
    branches:
      - staging

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pr:
    name: Create or Update Staging → Main PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Create Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          # Skip if staging has no commits ahead of main
          AHEAD=$(git rev-list --count origin/main..origin/staging)
          if [ "$AHEAD" -eq 0 ]; then
            echo "staging is not ahead of main — nothing to PR"
            exit 0
          fi
          echo "staging is $AHEAD commit(s) ahead of main"

          # Check if PR already exists
          EXISTING_PR=$(gh pr list -B main -H staging --json number -q '.[0].number' 2>/dev/null || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "PR #$EXISTING_PR already exists"
          else
            # Create the PR from staging to main
            gh pr create \
              -B main \
              -H staging \
              -t "Integration: Staging → Main" \
              -b "This PR integrates commits from the staging branch into main. It serves as an integration test to ensure all features and fixes work well together before production deployment."
          fi
