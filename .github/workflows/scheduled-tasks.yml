name: Scheduled Tasks

on:
  schedule:
    # Run daily at 2 AM UTC (9 PM ET / 6 PM PT)
    - cron: "0 2 * * *"
  workflow_dispatch: # Allow manual trigger

jobs:
  generate-subscription-orders:
    name: Generate Subscription Orders
    runs-on: ubuntu-latest
    steps:
      - uses: superfly/flyctl-actions/setup-flyctl@master
      - name: Ensure Fly machine is running
        shell: bash
        run: |
          set -euo pipefail

          # This app is configured with `min_machines_running = 0`, so it may be fully stopped
          # when the schedule fires. Ensure there's an `app` machine available to SSH into.
          flyctl scale count -a coffee-production app=1

          # If all machines are stopped, `scale count` may keep the desired count but still leave
          # nothing in a started state. Explicitly start one machine if needed.
          started_id=$(flyctl machines list -a coffee-production | awk 'NR>1 && $3=="started" {print $1; exit}')
          if [ -z "${started_id}" ]; then
            any_id=$(flyctl machines list -a coffee-production | awk 'NR>1 {print $1; exit}')
            if [ -n "${any_id}" ]; then
              flyctl machine start -a coffee-production "${any_id}" || true
            fi
          fi
      - name: Run subscription order generation
        shell: bash
        run: |
          set -euo pipefail

          # Give Fly a moment to start a machine before attempting SSH.
          for attempt in {1..10}; do
            if flyctl ssh console -a coffee-production -C "bin/rails subscriptions:generate_orders"; then
              exit 0
            fi

            echo "Attempt ${attempt} failed; waiting for machine startup..." >&2
            sleep 6
          done

          echo "Failed to run scheduled task after retries." >&2
          exit 1
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
